
import os
import csv
from datetime import datetime, timedelta
from tabulate import tabulate
from lib.services.sales_service import SalesService
from lib.services.item_service import ItemService
from lib.services.customer_service import CustomerService

class ReportsMenu:
    def __init__(self):
        self.sales_service = SalesService()
        self.item_service = ItemService()
        self.customer_service = CustomerService()

    def clear_screen(self):
        """Clear the terminal screen"""
        os.system('cls' if os.name == 'nt' else 'clear')

    def display_header(self):
        """Display the menu header"""
        print("=" * 70)
        print("                 REPORTS & ANALYTICS CENTER")
        print("=" * 70)
        print()

    def display_menu(self):
        """Display reports menu options"""
        menu_options = [
            ["1", "üìä Sales Dashboard", "Comprehensive sales overview"],
            ["2", "üì¶ Inventory Analysis", "Detailed inventory insights"],
            ["3", "üë• Customer Analytics", "Customer behavior analysis"],
            ["4", "üí∞ Financial Report", "Revenue & profit analysis"],
            ["5", "üè∑Ô∏è  Category Performance", "Sales performance by category"],
            ["6", "üìà Trend Analysis", "Sales trends over time"],
            ["7", "‚ö†Ô∏è  Alerts & Warnings", "Low stock & business alerts"],
            ["8", "üìÑ Export Reports", "Export data to CSV/files"],
            ["9", "üéØ Custom Report", "Build custom analytics"],
            ["10", "üì± Quick Stats", "At-a-glance business metrics"],
            ["11", "üîô Back to Main Menu", "Return to main menu"]
        ]

        print("üìä REPORTS & ANALYTICS MENU")
        print(tabulate(menu_options, headers=["Option", "Report Type", "Description"], tablefmt="grid"))
        print()

    def get_user_choice(self):
        """Get user's menu choice"""
        while True:
            try:
                choice = input("Enter your choice (1-11): ").strip()
                if choice in [str(i) for i in range(1, 12)]:
                    return choice
                else:
                    print("‚ùå Invalid choice. Please enter a number between 1-11.")
            except KeyboardInterrupt:
                return '11'

    def sales_dashboard(self):
        """Comprehensive sales dashboard"""
        self.clear_screen()
        self.display_header()
        print("üìä SALES DASHBOARD")
        print("=" * 60)

        try:
            summary = self.sales_service.get_sales_summary()

            # Key Performance Indicators
            print("üéØ KEY PERFORMANCE INDICATORS")
            print("-" * 50)
            kpi_data = [
                ["üí∞ Total Revenue", f"${summary['total_revenue']:.2f}"],
                ["üõí Total Sales", f"{summary['total_sales']} transactions"],
                ["üíµ Average Sale", f"${summary['average_sale']:.2f}"],
                ["üìà Daily Average", f"${summary['today_revenue']:.2f}"],
                ["üèÜ Conversion Rate", self._calculate_conversion_rate()],
                ["üìä Growth Rate", self._calculate_growth_rate()]
            ]
            print(tabulate(kpi_data, headers=["Metric", "Value"], tablefmt="fancy_grid"))

            # Time-based performance
            print(f"\n‚è∞ PERFORMANCE BY TIME PERIOD")
            print("-" * 50)
            periods_data = [
                ["Today", summary['today_sales'], f"${summary['today_revenue']:.2f}", self._get_period_growth('today')],
                ["This Week", summary['week_sales'], f"${summary['week_revenue']:.2f}", self._get_period_growth('week')],
                ["This Month", summary['month_sales'], f"${summary['month_revenue']:.2f}", self._get_period_growth('month')]
            ]
            print(tabulate(periods_data, headers=["Period", "Sales", "Revenue", "Growth"], tablefmt="fancy_grid"))

            # Top performers
            print(f"\nüèÜ TOP PERFORMERS")
            print("-" * 50)
            top_items = self.sales_service.get_top_selling_items(limit=5)

            if top_items:
                items_data = []
                for i, item_data in enumerate(top_items, 1):
                    profit_margin = self._calculate_item_profit_margin(item_data)
                    items_data.append([
                        f"#{i}",
                        item_data['name'][:25],
                        item_data['total_sold'],
                        f"${item_data['total_revenue']:.2f}",
                        f"{profit_margin:.1f}%"
                    ])

                headers = ["Rank", "Item", "Units Sold", "Revenue", "Margin"]
                print(tabulate(items_data, headers=headers, tablefmt="fancy_grid"))

            # Sales velocity
            print(f"\nüöÄ SALES VELOCITY")
            print("-" * 50)
            velocity_data = self._calculate_sales_velocity()
            print(tabulate(velocity_data, headers=["Metric", "Value", "Trend"], tablefmt="fancy_grid"))

        except Exception as e:
            print(f"‚ùå Error generating sales dashboard: {e}")

        input("\nPress Enter to continue...")

    def inventory_analysis(self):
        """Detailed inventory analysis"""
        self.clear_screen()
        self.display_header()
        print("üì¶ INVENTORY ANALYSIS")
        print("=" * 60)

        try:
            items = self.item_service.get_all_items()

            if not items:
                print("No items in inventory.")
                input("\nPress Enter to continue...")
                return

            # Inventory health metrics
            total_items = len(items)
            available_items = len([i for i in items if not i.is_sold and i.quantity > 0])
            sold_items = len([i for i in items if i.is_sold])
            low_stock_items = len([i for i in items if i.quantity <= 5 and not i.is_sold])
            out_of_stock = len([i for i in items if i.quantity == 0 and not i.is_sold])

            total_value = sum(item.price * item.quantity for item in items if not item.is_sold)
            total_cost = sum(item.cost * item.quantity for item in items if not item.is_sold)
            potential_profit = total_value - total_cost

            print("üíä INVENTORY HEALTH")
            print("-" * 50)
            health_data = [
                ["üìä Total Items", total_items, self._get_health_indicator(total_items, 100)],
                ["‚úÖ Available", available_items, self._get_health_indicator(available_items, total_items * 0.7)],
                ["üí∞ Sold Items", sold_items, "üìà Good"],
                ["‚ö†Ô∏è  Low Stock (‚â§5)", low_stock_items, "üî¥ Critical" if low_stock_items > 10 else "üü° Monitor"],
                ["‚ùå Out of Stock", out_of_stock, "üî¥ Critical" if out_of_stock > 5 else "‚úÖ Good"],
                ["üíµ Inventory Value", f"${total_value:.2f}", "üí∞"],
                ["üè≠ Inventory Cost", f"${total_cost:.2f}", "üí∏"],
                ["üìà Potential Profit", f"${potential_profit:.2f}", f"{((potential_profit/total_cost)*100):.1f}%" if total_cost > 0 else "N/A"]
            ]
            print(tabulate(health_data, headers=["Metric", "Value", "Status"], tablefmt="fancy_grid"))

            # Category performance
            print(f"\nüè∑Ô∏è  CATEGORY PERFORMANCE")
            print("-" * 50)
            categories = self._analyze_categories(items)

            if categories:
                category_data = []
                for category, data in sorted(categories.items(), key=lambda x: x[1]['value'], reverse=True):
                    turnover_rate = self._calculate_turnover_rate(category)
                    category_data.append([
                        category,
                        data['count'],
                        f"${data['value']:.2f}",
                        data['avg_price'],
                        f"{turnover_rate:.1f}x"
                    ])

                headers = ["Category", "Items", "Total Value", "Avg Price", "Turnover"]
                print(tabulate(category_data, headers=headers, tablefmt="fancy_grid"))

            # ABC Analysis (Pareto)
            print(f"\nüìä ABC ANALYSIS (PARETO)")
            print("-" * 50)
            abc_analysis = self._perform_abc_analysis(items)
            print(tabulate(abc_analysis, headers=["Class", "Items", "% of Items", "Revenue", "% of Revenue"], tablefmt="fancy_grid"))

            # Aging analysis
            print(f"\n‚è∞ INVENTORY AGING")
            print("-" * 50)
            aging_data = self._analyze_inventory_aging(items)
            print(tabulate(aging_data, headers=["Age Range", "Items", "Value", "Recommendation"], tablefmt="fancy_grid"))

        except Exception as e:
            print(f"‚ùå Error generating inventory analysis: {e}")

        input("\nPress Enter to continue...")

    def customer_analytics(self):
        """Advanced customer analytics"""
        self.clear_screen()
        self.display_header()
        print("üë• CUSTOMER ANALYTICS")
        print("=" * 60)

        try:
            customers = self.customer_service.get_all_customers()

            if not customers:
                print("No customers found.")
                input("\nPress Enter to continue...")
                return

            # Customer segmentation
            print("üéØ CUSTOMER SEGMENTATION")
            print("-" * 50)

            segments = self._segment_customers(customers)
            segment_data = []
            for segment, data in segments.items():
                segment_data.append([
                    segment,
                    data['count'],
                    f"{(data['count']/len(customers)*100):.1f}%",
                    f"${data['avg_spending']:.2f}",
                    data['characteristics']
                ])

            headers = ["Segment", "Count", "% of Base", "Avg Spending", "Characteristics"]
            print(tabulate(segment_data, headers=headers, tablefmt="fancy_grid"))

            # Customer lifetime value
            print(f"\nüíé TOP CUSTOMERS BY LIFETIME VALUE")
            print("-" * 50)

            customer_ltv = []
            for customer in customers:
                _, sales = self.customer_service.get_customer_with_sales(customer.id)
                total_spent = sum(sale.final_total for sale in sales if sale.status != 'cancelled')
                avg_order_value = total_spent / len(sales) if sales else 0
                purchase_frequency = len(sales)

                if total_spent > 0:
                    ltv_score = self._calculate_ltv_score(total_spent, purchase_frequency, avg_order_value)
                    customer_ltv.append({
                        'name': customer.full_name,
                        'total_spent': total_spent,
                        'orders': purchase_frequency,
                        'avg_order': avg_order_value,
                        'ltv_score': ltv_score,
                        'segment': self._get_customer_segment(total_spent, purchase_frequency)
                    })

            # Sort by LTV score
            customer_ltv.sort(key=lambda x: x['ltv_score'], reverse=True)

            if customer_ltv:
                ltv_data = []
                for i, customer in enumerate(customer_ltv[:10], 1):
                    ltv_data.append([
                        i,
                        customer['name'][:20],
                        customer['orders'],
                        f"${customer['avg_order']:.2f}",
                        f"${customer['total_spent']:.2f}",
                        customer['segment']
                    ])

                headers = ["Rank", "Customer", "Orders", "Avg Order", "Total Spent", "Segment"]
                print(tabulate(ltv_data, headers=headers, tablefmt="fancy_grid"))

            # Customer behavior insights
            print(f"\nüß† CUSTOMER BEHAVIOR INSIGHTS")
            print("-" * 50)
            insights = self._generate_customer_insights(customers)
            for insight in insights:
                print(f"üí° {insight}")

        except Exception as e:
            print(f"‚ùå Error generating customer analytics: {e}")

        input("\nPress Enter to continue...")

    def financial_report(self):
        """Comprehensive financial analysis"""
        self.clear_screen()
        self.display_header()
        print("üí∞ FINANCIAL REPORT")
        print("=" * 60)

        try:
            summary = self.sales_service.get_sales_summary()

            # Revenue analysis
            print("üí∞ REVENUE ANALYSIS")
            print("-" * 50)

            # Calculate costs and profits
            total_cost = self._calculate_total_costs()
            gross_profit = summary['total_revenue'] - total_cost
            profit_margin = (gross_profit / summary['total_revenue'] * 100) if summary['total_revenue'] > 0 else 0

            revenue_data = [
                ["üíµ Gross Revenue", f"${summary['total_revenue']:.2f}", "100.0%"],
                ["üí∏ Total Costs", f"${total_cost:.2f}", f"{(total_cost/summary['total_revenue']*100):.1f}%" if summary['total_revenue'] > 0 else "0%"],
                ["üí∞ Gross Profit", f"${gross_profit:.2f}", f"{profit_margin:.1f}%"],
                ["üìä Profit Margin", f"{profit_margin:.2f}%", self._get_margin_rating(profit_margin)],
                ["üí≥ Avg Transaction", f"${summary['average_sale']:.2f}", ""],
                ["üéØ Break-even Point", self._calculate_breakeven(), ""]
            ]
            print(tabulate(revenue_data, headers=["Metric", "Amount", "% of Revenue"], tablefmt="fancy_grid"))

            # Cash flow analysis
            print(f"\nüí≥ CASH FLOW ANALYSIS")
            print("-" * 50)
            cash_flow = self._analyze_cash_flow()
            print(tabulate(cash_flow, headers=["Period", "Inflow", "Outflow", "Net Flow", "Trend"], tablefmt="fancy_grid"))

            # Profitability by category
            print(f"\nüìä PROFITABILITY BY CATEGORY")
            print("-" * 50)
            category_profit = self._analyze_category_profitability()
            print(tabulate(category_profit, headers=["Category", "Revenue", "Cost", "Profit", "Margin"], tablefmt="fancy_grid"))

            # Financial ratios
            print(f"\nüìà FINANCIAL RATIOS")
            print("-" * 50)
            ratios = self._calculate_financial_ratios(summary, total_cost, gross_profit)
            print(tabulate(ratios, headers=["Ratio", "Value", "Industry Avg", "Status"], tablefmt="fancy_grid"))

        except Exception as e:
            print(f"‚ùå Error generating financial report: {e}")

        input("\nPress Enter to continue...")

    def trend_analysis(self):
        """Sales trends and forecasting"""
        self.clear_screen()
        self.display_header()
        print("üìà TREND ANALYSIS & FORECASTING")
        print("=" * 60)

        try:
            # Daily sales trend
            print("üìÖ DAILY SALES TREND (Last 30 Days)")
            print("-" * 50)
            daily_trends = self._get_daily_trends(30)

            # Create simple ASCII chart
            self._display_trend_chart(daily_trends, "Daily Sales")

            # Weekly comparison
            print(f"\nüìä WEEKLY PERFORMANCE")
            print("-" * 50)
            weekly_data = self._get_weekly_comparison()
            print(tabulate(weekly_data, headers=["Week", "Sales", "Revenue", "Avg Order", "Growth"], tablefmt="fancy_grid"))

            # Seasonal patterns
            print(f"\nüåü SEASONAL PATTERNS")
            print("-" * 50)
            seasonal_data = self._analyze_seasonal_patterns()
            print(tabulate(seasonal_data, headers=["Pattern", "Description", "Impact", "Recommendation"], tablefmt="fancy_grid"))

            # Forecasting
            print(f"\nüîÆ SALES FORECAST")
            print("-" * 50)
            forecast = self._generate_forecast()
            print(tabulate(forecast, headers=["Period", "Predicted Sales", "Predicted Revenue", "Confidence"], tablefmt="fancy_grid"))

        except Exception as e:
            print(f"‚ùå Error generating trend analysis: {e}")

        input("\nPress Enter to continue...")

    def alerts_warnings(self):
        """Business alerts and warnings"""
        self.clear_screen()
        self.display_header()
        print("‚ö†Ô∏è  BUSINESS ALERTS & WARNINGS")
        print("=" * 60)

        try:
            alerts = []

            # Inventory alerts
            items = self.item_service.get_all_items()
            low_stock = [i for i in items if i.quantity <= 5 and not i.is_sold]
            out_of_stock = [i for i in items if i.quantity == 0 and not i.is_sold]

            if low_stock:
                alerts.append(("üü° LOW STOCK", f"{len(low_stock)} items with 5 or fewer units", "MEDIUM"))

            if out_of_stock:
                alerts.append(("üî¥ OUT OF STOCK", f"{len(out_of_stock)} items completely out of stock", "HIGH"))

            # Sales performance alerts
            summary = self.sales_service.get_sales_summary()

            if summary['today_sales'] == 0:
                alerts.append(("üìâ NO SALES TODAY", "No sales recorded today", "MEDIUM"))

            if summary['week_sales'] < summary['month_sales'] / 4:
                alerts.append(("üìä BELOW AVERAGE", "This week's sales below monthly average", "LOW"))

            # Stale inventory
            stale_items = self._find_stale_inventory(items, days=90)
            if stale_items:
                alerts.append(("‚è∞ STALE INVENTORY", f"{len(stale_items)} items older than 90 days", "MEDIUM"))

            # Price optimization opportunities
            price_alerts = self._find_pricing_opportunities()
            alerts.extend(price_alerts)

            # Display alerts
            if alerts:
                print("üö® ACTIVE ALERTS")
                print("-" * 50)

                alert_data = []
                for alert_type, message, priority in alerts:
                    priority_icon = {"HIGH": "üî¥", "MEDIUM": "üü°", "LOW": "üü¢"}[priority]
                    alert_data.append([
                        priority_icon,
                        alert_type,
                        message,
                        priority
                    ])

                headers = ["", "Alert Type", "Description", "Priority"]
                print(tabulate(alert_data, headers=headers, tablefmt="fancy_grid"))

                # Recommendations
                print(f"\nüí° RECOMMENDATIONS")
                print("-" * 50)
                recommendations = self._generate_recommendations(alerts)
                for i, rec in enumerate(recommendations, 1):
                    print(f"{i}. {rec}")
            else:
                print("‚úÖ No active alerts. Business is running smoothly!")

        except Exception as e:
            print(f"‚ùå Error generating alerts: {e}")

        input("\nPress Enter to continue...")

    def export_reports(self):
        """Export reports to various formats"""
        self.clear_screen()
        self.display_header()
        print("üìÑ EXPORT REPORTS")
        print("=" * 60)

        export_options = [
            ["1", "üìä Sales Report CSV", "Export sales data to CSV"],
            ["2", "üì¶ Inventory Report CSV", "Export inventory data to CSV"],
            ["3", "üë• Customer Report CSV", "Export customer data to CSV"],
            ["4", "üí∞ Financial Summary PDF", "Export financial summary"],
            ["5", "üìà Complete Analytics Package", "Export all reports"],
            ["6", "üîô Back to Reports Menu", "Return to reports menu"]
        ]

        print(tabulate(export_options, headers=["Option", "Export Type", "Description"], tablefmt="grid"))

        choice = input("\nSelect export option (1-6): ").strip()

        try:
            if choice == '1':
                self._export_sales_csv()
            elif choice == '2':
                self._export_inventory_csv()
            elif choice == '3':
                self._export_customers_csv()
            elif choice == '4':
                self._export_financial_summary()
            elif choice == '5':
                self._export_complete_package()
            elif choice == '6':
                return
            else:
                print("‚ùå Invalid option!")
        except Exception as e:
            print(f"‚ùå Export error: {e}")

        input("\nPress Enter to continue...")

    def quick_stats(self):
        """Quick at-a-glance statistics"""
        self.clear_screen()
        self.display_header()
        print("üì± QUICK BUSINESS STATS")
        print("=" * 60)

        try:
            summary = self.sales_service.get_sales_summary()
            items = self.item_service.get_all_items()
            customers = self.customer_service.get_all_customers()

            # Quick metrics
            available_items = len([i for i in items if not i.is_sold and i.quantity > 0])
            total_value = sum(item.price * item.quantity for item in items if not item.is_sold)

            stats = [
                ["üí∞", "Today's Revenue", f"${summary['today_revenue']:.2f}"],
                ["üõí", "Today's Sales", f"{summary['today_sales']} transactions"],
                ["üì¶", "Items in Stock", f"{available_items} items"],
                ["üíµ", "Inventory Value", f"${total_value:.2f}"],
                ["üë•", "Total Customers", f"{len(customers)} customers"],
                ["üìä", "Average Sale", f"${summary['average_sale']:.2f}"],
                ["üèÜ", "Best Category", self._get_best_category()],
                ["üìà", "Monthly Growth", self._get_monthly_growth()]
            ]

            # Display in a compact format
            for icon, metric, value in stats[:4]:
                print(f"{icon} {metric:<20} {value:>15}")

            print("-" * 40)

            for icon, metric, value in stats[4:]:
                print(f"{icon} {metric:<20} {value:>15}")

            print("\n" + "=" * 40)
            print("üìä Business Health Score:", self._calculate_health_score())
            print("=" * 40)

        except Exception as e:
            print(f"‚ùå Error generating quick stats: {e}")

        input("\nPress Enter to continue...")

    # Helper methods for calculations and analysis
    def _calculate_conversion_rate(self):
        """Calculate conversion rate (placeholder)"""
        return "85.2%"  # This would need visitor tracking data

    def _calculate_growth_rate(self):
        """Calculate growth rate"""
        return "12.5%"  # This would compare with previous periods

    def _get_period_growth(self, period):
        """Get growth for a specific period"""
        return "+15.2%"  # Placeholder - would calculate actual growth

    def _calculate_item_profit_margin(self, item_data):
        """Calculate profit margin for an item"""
        return 45.0  # Placeholder - would use actual cost data

    def _calculate_sales_velocity(self):
        """Calculate sales velocity metrics"""
        return [
            ["Items/Day", "24.5", "üìà +5%"],
            ["Revenue/Hour", "$125.30", "üìà +12%"],
            ["Customer/Day", "18.2", "üìä Stable"]
        ]

    # Additional helper methods would continue here...
    # (Implementation of all helper methods would follow similar patterns)

    def run(self):
        """Run the reports menu"""
        while True:
            try:
                self.clear_screen()
                self.display_header()
                self.display_menu()

                choice = self.get_user_choice()

                if choice == '1':
                    self.sales_dashboard()
                elif choice == '2':
                    self.inventory_analysis()
                elif choice == '3':
                    self.customer_analytics()
                elif choice == '4':
                    self.financial_report()
                elif choice == '5':
                    self.category_report()
                elif choice == '6':
                    self.trend_analysis()
                elif choice == '7':
                    self.alerts_warnings()
                elif choice == '8':
                    self.export_reports()
                elif choice == '9':
                    self.custom_report()
                elif choice == '10':
                    self.quick_stats()
                elif choice == '11':
                    break
            except Exception as e:
                print(f"‚ùå An error occurred: {e}")
                input("Press Enter to continue...")

# Usage example:
if __name__ == "__main__":
    reports_menu = ReportsMenu()
    reports_menu.run()